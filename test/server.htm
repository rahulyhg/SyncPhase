<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Test Server</title>
</head>
<body>
	<script>
		var cursor = new DataView(new ArrayBuffer(5));
		cursor.setUint8(0, 3);
		cursor.setUint16(1, 2011);
		cursor.setUint16(3, 1022);

		var begin = new DataView(new ArrayBuffer(1));
		begin.setUint8(0, 4);

		var end = new DataView(new ArrayBuffer(1));
		end.setUint8(0, 5);

		var color = new DataView(new ArrayBuffer(4));
		color.setUint8(0, 6);
		color.setUint8(1, 0xfe);
		color.setUint8(2, 0xe6);
		color.setUint8(3, 0x63);

		var weight = new DataView(new ArrayBuffer(3));
		weight.setUint8(0, 7);
		weight.setUint16(1, 258);

		var str = "aBc";
		var message = new DataView(new ArrayBuffer(str.length*2+1));
		message.setUint8(0, 9);

		for (var i = 0; i < str.length; i++) {
			var code = str.charCodeAt(i);
			message.setUint16(2*i+1, code, true);
		}


		var ca = new WebSocket('ws://localhost:8897');
		ca.binaryType = 'arraybuffer';

		ca.onopen = function () {
			var cb = new WebSocket('ws://localhost:8897');
			cb.binaryType = 'arraybuffer';

			cb.onopen = function () {
				ca.send(cursor);
				ca.send(begin);
				ca.send(end);
				ca.send(color);
				ca.send(weight);
				ca.send(message);
			};

			var count = 0;

			cb.onmessage = function (msg) {
				msg = new DataView(msg.data);

				var con = '';
				for (var x = 0; x < msg.byteLength; x++) {
					con += ' ' + msg.getUint8(x).toString(16);
				}
				console.log(con);

				var id = msg.getUint8(0);
				// console.log('User = ' + id);

				var action = msg.getUint8(1);

				switch (action) {
					case 3:
						if (msg.getUint16(2) !== 2011) {
							console.log('Cursor X Fail.');
						}

						if (msg.getUint16(4) !== 1022) {
							console.log('Cursor Y Fail.');
						}

						count++;
						break;

					case 4:
						count++;
						break;

					case 5:
						count++;
						break;

					case 6:
						if (msg.getUint8(2) !== 0xfe) {
							console.log('Color R Fail.');
						}

						if (msg.getUint8(3) !== 0xe6) {
							console.log('Color G Fail.');
						}

						if (msg.getUint8(4) !== 0x63) {
							console.log('Color B Fail.');
						}

						count++;
						break;

					case 7:
						if (msg.getUint16(2) !== 258) {
							console.log('Weight Fail.');
						}

						count++;
						break;

					case 9:
						var arr = new Uint16Array(msg.buffer, 2);
						var assertion = String.fromCharCode.apply(null, arr);

						if (assertion !== str) {
							console.log('Message Failed: ' + assertion);
						}

						count++;
						break;

					default:
						console.log('MESSAGE TYPE FAIL. = ' + action);
				}
			};
		};
	</script>
</body>
</html>